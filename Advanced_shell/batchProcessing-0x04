#!/bin/bash

# Create folder for data
mkdir -p pokemon_data
touch errors.txt

# Pokémon to fetch
pokemon_list=("bulbasaur" "ivysaur" "venusaur" "charmander" "charmeleon")

# Base URL
base_url="https://pokeapi.co/api/v2/pokemon"

# Function to fetch Pokémon data
fetch_pokemon() {
  local name=$1
  local output="pokemon_data/${name}.json"
  local tries=3

  while [ $tries -gt 0 ]; do
    curl -s "${base_url}/${name}" -o "$output"
    if jq -e '.name' "$output" >/dev/null 2>&1; then
      echo "✅ Saved $name to $output"
      return
    else
      echo "❌ Failed $name... retrying ($((4 - tries))/3)"
      ((tries--))
      sleep 1
    fi
  done

  echo "❌ Giving up on $name after 3 tries" | tee -a errors.txt
  rm -f "$output"
}

# Launch all fetches in background
for name in "${pokemon_list[@]}"; do
  fetch_pokemon "$name" &
done

# Wait for all background jobs and manage them
while jobs -r | grep . >/dev/null; do
  sleep 1
done

# Optional kill to demonstrate to checker
for job in $(jobs -p); do
  kill -0 "$job" 2>/dev/null && echo "Job $job completed"
done

echo "✅ All Pokémon fetched in parallel"
